name: ssh
version: ##VERSION##
description: |-
  DevPod on SSH
icon: https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRd5m6p7NQAaWtXgiKhejkAG_nzUiE1BEu4Fw&usqp=CAU
optionGroups:
  - options:
      - AGENT_PATH
      - INACTIVITY_TIMEOUT
      - INJECT_DOCKER_CREDENTIALS
      - INJECT_GIT_CREDENTIALS
    name: "Agent options"
    defaultVisible: false
  - options:
      - PORT
      - EXTRA_FLAGS
    name: "SSH options"
    defaultVisible: true
options:
  INACTIVITY_TIMEOUT:
    description: "If defined, will automatically stop the container after the inactivity period. Example: 10m"
  AGENT_PATH:
    description: The path where to inject the DevPod agent to.
    default: /opt/devpod/agent
  INJECT_GIT_CREDENTIALS:
    description: "If DevPod should inject git credentials into the remote host."
    default: "true"
  INJECT_DOCKER_CREDENTIALS:
    description: "If DevPod should inject docker credentials into the remote host."
    default: "true"
  HOST:
    required: true
    description: 'The SSH Host to connect to. Example: my-user@my-domain.com'
  PORT:
    description: "The SSH Port to use. Defaults to 22"
    default: "22"
  EXTRA_FLAGS:
    description: "Extra flags to pass to the SSH command."
agent:
  inactivityTimeout: ${INACTIVITY_TIMEOUT}
  injectGitCredentials: ${INJECT_GIT_CREDENTIALS}
  injectDockerCredentials: ${INJECT_DOCKER_CREDENTIALS}
  path: ${AGENT_PATH}
exec:
  init: |-
    OUTPUT=$(ssh -oStrictHostKeyChecking=no \
                 -p ${PORT} \
                 ${EXTRA_FLAGS} \
                 "${HOST}" \
                 'sh -c "echo DevPodTest"')

    if [ "$OUTPUT" != "DevPodTest" ]; then
      >&2 echo "Unexpected ssh output."
      >&2 echo "Please make sure you have configured the correct SSH host"
      >&2 echo "and the following command can be executed on your system:"
      >&2 echo ssh -oStrictHostKeyChecking=no -p "${PORT}" "${HOST}" 'sh -c "echo DevPodTest"'
      exit 1
    fi

  command: |-
    ssh -oStrictHostKeyChecking=no \
        -p ${PORT} \
        "${EXTRA_FLAGS}" \
        "${HOST}" \
        "${COMMAND}"
